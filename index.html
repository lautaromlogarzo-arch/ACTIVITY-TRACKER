<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker de Desempeño - FSAE & Training</title>

    <link rel="icon" type="image/png" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d62828">
    <link rel="apple-touch-icon" href="logo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #d62828; 
            --dark: #1e1e1e;
            --light: #f4f4f4;
            --success: #2ecc71;
            --bg: #121212;
            --card: #1e1e24;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; background-color: var(--bg); color: var(--light);
            display: flex; flex-direction: column; height: 100vh;
        }

        header {
            background-color: var(--card); padding: 15px; text-align: center;
            border-bottom: 3px solid var(--primary);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }

        nav { display: flex; background: var(--card); }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; transition: 0.3s; border-bottom: 2px solid transparent; text-transform: uppercase; font-size: 0.9rem; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); background: rgba(214, 40, 40, 0.1); }
        .tab-btn i { margin-right: 8px; }

        main { flex: 1; overflow-y: auto; padding: 20px; max-width: 600px; width: 100%; margin: 0 auto; box-sizing: border-box; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos Ingreso */
        .date-picker-container { text-align: center; margin-bottom: 25px; }
        input[type="date"] { background: var(--card); color: white; border: 1px solid #444; padding: 10px; border-radius: 8px; font-size: 1.1rem; font-family: inherit; }
        
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item { background: var(--card); padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #333; transition: transform 0.1s; cursor: pointer; }
        .task-item:active { transform: scale(0.98); }
        .task-label { font-size: 1rem; font-weight: 500; display: flex; flex-direction: column; }
        
        .task-counter { font-size: 0.75rem; color: #888; margin-top: 2px; font-weight: normal; }
        .task-counter.completed { color: var(--success); font-weight: bold; }
        
        .task-icon { font-size: 1.3rem; margin-right: 15px; width: 25px; text-align: center; }
        .custom-checkbox { width: 24px; height: 24px; border: 2px solid #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .custom-checkbox.checked { background-color: var(--success); border-color: var(--success); }
        .custom-checkbox i { color: white; display: none; font-size: 0.8rem; }
        .custom-checkbox.checked i { display: block; }

        /* Estilos Desempeño */
        .chart-controls { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .chart-btn { background: var(--card); color: #888; border: 1px solid #444; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; flex: 1; max-width: 100px; text-align: center;}
        .chart-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .chart-container { background: var(--card); padding: 15px; border-radius: 12px; height: 300px; position: relative; }
        .stats-summary { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 10px 20px; border-radius: 8px; text-align: center; border-top: 3px solid var(--primary); }
        .stat-val { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-lbl { font-size: 0.8rem; color: #aaa; }

        /* Estilo para el detalle de tareas faltantes */
        #missingTasksContainer {
            margin-top: 20px;
            padding: 15px;
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
            display: none; /* Se oculta por defecto */
        }
        .missing-title { font-weight: bold; color: #e74c3c; margin-bottom: 5px; font-size: 0.9rem; }
        .missing-list { margin: 0; padding-left: 20px; color: #ccc; font-size: 0.85rem; }
        
        .success-message {
            margin-top: 20px;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            border-radius: 4px;
            color: #2ecc71;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        /* Estilos Historial */
        .history-list { list-style: none; padding: 0; }
        .history-item { background: var(--card); margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #555; cursor: pointer; }
        .score-0 { border-left-color: #555; }
        .score-20 { border-left-color: #e74c3c; } 
        .score-40 { border-left-color: #e67e22; } 
        .score-60 { border-left-color: #f1c40f; } 
        .score-80 { border-left-color: #3498db; } 
        .score-100 { border-left-color: #2ecc71; } 
        .hist-date { font-weight: bold; color: #fff; }
        .hist-details { font-size: 0.85rem; color: #aaa; margin-top: 4px; }
        .hist-score { font-weight: bold; font-size: 1.2rem; }

        @media (max-width: 480px) {
            .tab-btn span { display: none; }
            .tab-btn i { margin: 0; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fa-solid fa-flag-checkered" style="color:var(--primary)"></i> Performance Tracker</h1>
    </header>

    <nav>
        <button class="tab-btn active" onclick="openTab('ingreso')">
            <i class="fa-solid fa-pen-to-square"></i> <span>Ingreso</span>
        </button>
        <button class="tab-btn" onclick="openTab('desempeno')">
            <i class="fa-solid fa-chart-line"></i> <span>Desempeño</span>
        </button>
        <button class="tab-btn" onclick="openTab('historial')">
            <i class="fa-solid fa-clock-rotate-left"></i> <span>Historial</span>
        </button>
    </nav>

    <main>
        <div id="ingreso" class="tab-content active">
            <div class="date-picker-container">
                <label style="display:block; margin-bottom:5px; color:#aaa;">Seleccionar Fecha:</label>
                <input type="date" id="dateInput" onchange="loadDayData()">
                <div id="todayIndicator" style="margin-top:5px; font-size:0.8rem; color:var(--primary); font-weight:bold; display:none;">DÍA DE HOY</div>
            </div>

            <div class="task-list">
                <div class="task-item" onclick="toggleTask('movilidad')">
                    <div style="display:flex; align-items:center;">
                        <div class="task-icon" style="color: #f1c40f;"><i class="fa-solid fa-person-walking"></i></div>
                        <div><span class="task-label">Rutina de Movilidad</span><span id="count-movilidad" class="task-counter">Semana: 0/3</span></div>
                    </div>
                    <div class="custom-checkbox" id="check-movilidad"><i class="fa-solid fa-check"></i></div>
                </div>
                <div class="task-item" onclick="toggleTask('superior')">
                    <div style="display:flex; align-items:center;">
                        <div class="task-icon" style="color: #3498db;"><i class="fa-solid fa-dumbbell"></i></div>
                        <div><span class="task-label">Tren Superior</span><span id="count-superior" class="task-counter">Semana: 0/3</span></div>
                    </div>
                    <div class="custom-checkbox" id="check-superior"><i class="fa-solid fa-check"></i></div>
                </div>
                <div class="task-item" onclick="toggleTask('inferior')">
                    <div style="display:flex; align-items:center;">
                        <div class="task-icon" style="color: #9b59b6;"><i class="fa-solid fa-shoe-prints"></i></div>
                        <div><span class="task-label">Tren Inferior</span><span id="count-inferior" class="task-counter">Semana: 0/2</span></div>
                    </div>
                    <div class="custom-checkbox" id="check-inferior"><i class="fa-solid fa-check"></i></div>
                </div>
                <div class="task-item" onclick="toggleTask('cuello')">
                    <div style="display:flex; align-items:center;">
                        <div class="task-icon" style="color: #e67e22;"><i class="fa-solid fa-helmet-safety"></i></div>
                        <div><span class="task-label">Entreno Cuello</span><span id="count-cuello" class="task-counter">Semana: 0/2</span></div>
                    </div>
                    <div class="custom-checkbox" id="check-cuello"><i class="fa-solid fa-check"></i></div>
                </div>
                <div class="task-item" onclick="toggleTask('fsae')">
                    <div style="display:flex; align-items:center;">
                        <div class="task-icon" style="color: var(--primary);"><i class="fa-solid fa-car-side"></i></div>
                        <div><span class="task-label">Desarrollo FSAE</span><span id="count-fsae" class="task-counter">Semana: 0/4</span></div>
                    </div>
                    <div class="custom-checkbox" id="check-fsae"><i class="fa-solid fa-check"></i></div>
                </div>
            </div>
        </div>

        <div id="desempeno" class="tab-content">
            <div class="stats-summary">
                <div class="stat-box"><span class="stat-val" id="currentScore">0%</span><span class="stat-lbl">Esta Semana</span></div>
                <div class="stat-box"><span class="stat-val" id="goalsMet">0/5</span><span class="stat-lbl">Objetivos Cumplidos</span></div>
            </div>

            <div class="chart-controls">
                <button class="chart-btn active" onclick="setChartMode('current')">Esta Semana</button>
                <button class="chart-btn" onclick="setChartMode('weeks')">Hist. Semanal</button>
                <button class="chart-btn" onclick="setChartMode('months')">Hist. Anual</button>
            </div>

            <h3 style="margin-bottom:10px; text-align:center;" id="chartTitle">Progreso Actual</h3>
            <div class="chart-container"><canvas id="performanceChart"></canvas></div>
            
            <div id="missingTasksContainer">
                <div class="missing-title"><i class="fa-solid fa-triangle-exclamation"></i> Para llegar al 100%:</div>
                <ul class="missing-list" id="missingList">
                    </ul>
            </div>

            <div id="successMessage" class="success-message">
                <i class="fa-solid fa-trophy"></i> ¡Objetivos de la semana completados!
            </div>

            <div id="chartFooterText" style="margin-top:20px; text-align:center; font-size:0.8rem; color:#aaa;">
                </div>
        </div>

        <div id="historial" class="tab-content">
            <h3 style="margin-bottom:15px;">Registro Diario</h3>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </main>

    <script>
        // --- CONFIGURACIÓN ---
        const METAS_SEMANALES = { movilidad: 3, superior: 3, inferior: 2, cuello: 2, fsae: 4 };
        // Etiquetas para gráficas y listas
        const LABELS_MAP = {
            movilidad: 'Movilidad',
            superior: 'T. Superior',
            inferior: 'T. Inferior',
            cuello: 'Cuello',
            fsae: 'FSAE'
        };

        const STORAGE_KEY = 'fsae_tracker_data_v2';
        
        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
        let currentDateSelected = '';
        let myChart = null;
        let chartMode = 'current'; // Default: 'current' (Esta semana)

        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('dateInput');
            dateInput.max = today;
            dateInput.value = today;
            currentDateSelected = today;
            loadDayData();
        };

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            const btn = document.querySelector(`button[onclick="openTab('${tabName}')"]`);
            if(btn) btn.classList.add('active');

            if(tabName === 'desempeno') updateChart();
            if(tabName === 'historial') renderHistory();
        }

        // --- LÓGICA DE DATOS ---
        function loadDayData() {
            const dateInput = document.getElementById('dateInput');
            currentDateSelected = dateInput.value;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayIndicator').style.display = (currentDateSelected === today) ? 'block' : 'none';
            
            if(currentDateSelected > today) { 
                alert("No puedes registrar datos del futuro."); 
                dateInput.value = today; 
                currentDateSelected = today; 
            }

            const defaultDay = { movilidad: false, superior: false, inferior: false, cuello: false, fsae: false };
            const dayData = appData[currentDateSelected] || defaultDay;
            
            ['movilidad', 'superior', 'inferior', 'cuello', 'fsae'].forEach(task => {
                updateCheckboxUI('check-' + task, dayData[task]);
            });

            updateWeeklyCounters();
        }

        function toggleTask(taskName) {
            const defaultDay = { movilidad: false, superior: false, inferior: false, cuello: false, fsae: false };
            const dayData = appData[currentDateSelected] || defaultDay;
            dayData[taskName] = !dayData[taskName];
            appData[currentDateSelected] = dayData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            updateCheckboxUI(`check-${taskName}`, dayData[taskName]);
            updateWeeklyCounters();
        }

        function updateCheckboxUI(elementId, isChecked) {
            const el = document.getElementById(elementId);
            if(isChecked) el.classList.add('checked'); else el.classList.remove('checked');
        }

        // --- CÁLCULOS DE TIEMPO ---
        function getMonday(d) {
            d = new Date(d);
            d.setHours(0,0,0,0);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeeklyCounts(dateString) {
            let monday = getMonday(new Date(dateString + "T00:00:00"));
            let counts = { movilidad: 0, superior: 0, inferior: 0, cuello: 0, fsae: 0 };
            for (let i = 0; i < 7; i++) {
                let tempDate = new Date(monday);
                tempDate.setDate(monday.getDate() + i);
                let dateStr = tempDate.toISOString().split('T')[0];
                if (appData[dateStr]) {
                    Object.keys(counts).forEach(key => {
                        if(appData[dateStr][key]) counts[key]++;
                    });
                }
            }
            return counts;
        }

        function calculateWeeklyScore(dateString) {
            const counts = getWeeklyCounts(dateString);
            let goalsMet = 0;
            const keys = Object.keys(METAS_SEMANALES);
            keys.forEach(k => {
                if (counts[k] >= METAS_SEMANALES[k]) goalsMet++;
            });
            return { score: (goalsMet / 5) * 100, met: goalsMet };
        }

        function updateWeeklyCounters() {
            // Usamos la fecha seleccionada para calcular "esa" semana en la pestaña Ingreso
            const counts = getWeeklyCounts(currentDateSelected);
            const scoreData = calculateWeeklyScore(currentDateSelected);

            Object.keys(METAS_SEMANALES).forEach(key => {
                updateCounterText('count-' + key, counts[key], METAS_SEMANALES[key]);
            });

            document.getElementById('currentScore').innerText = Math.round(scoreData.score) + "%";
            document.getElementById('goalsMet').innerText = scoreData.met + "/5";
        }

        function updateCounterText(elementId, current, target) {
            const el = document.getElementById(elementId);
            el.innerText = `Semana: ${current}/${target}`;
            if (current >= target) {
                el.classList.add('completed');
                el.innerHTML += ' <i class="fa-solid fa-star" style="font-size:0.7rem"></i>';
            } else {
                el.classList.remove('completed');
            }
        }

        // --- GRÁFICOS Y VISTA "ESTA SEMANA" ---
        function setChartMode(mode) {
            chartMode = mode;
            const btns = document.querySelectorAll('.chart-btn');
            btns.forEach(b => b.classList.remove('active'));
            if(mode === 'current') btns[0].classList.add('active');
            else if(mode === 'weeks') btns[1].classList.add('active');
            else btns[2].classList.add('active');
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Ocultar elementos de detalle por defecto
            document.getElementById('missingTasksContainer').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('chartFooterText').innerText = "";

            let labels = [];
            let datasets = [];
            let chartType = 'line';

            if (chartMode === 'current') {
                document.getElementById('chartTitle').innerText = "Progreso Esta Semana";
                chartType = 'bar';
                
                // 1. Obtener datos actuales
                const currentCounts = getWeeklyCounts(todayStr);
                const keys = Object.keys(METAS_SEMANALES);
                
                // 2. Preparar datos para Bar Chart
                labels = keys.map(k => LABELS_MAP[k]);
                const dataCurrent = keys.map(k => currentCounts[k]);
                const dataGoals = keys.map(k => METAS_SEMANALES[k]);
                
                // 3. Generar Lista de Pendientes
                const missingList = document.getElementById('missingList');
                missingList.innerHTML = '';
                let somethingMissing = false;

                keys.forEach(k => {
                    const remaining = METAS_SEMANALES[k] - currentCounts[k];
                    if (remaining > 0) {
                        somethingMissing = true;
                        const li = document.createElement('li');
                        li.innerText = `Falta ${remaining} de ${LABELS_MAP[k]}`;
                        missingList.appendChild(li);
                    }
                });

                if (somethingMissing) {
                    document.getElementById('missingTasksContainer').style.display = 'block';
                } else {
                    document.getElementById('successMessage').style.display = 'block';
                }

                // 4. Configurar Dataset (Barras Superpuestas o Agrupadas)
                datasets = [
                    {
                        label: 'Meta',
                        data: dataGoals,
                        backgroundColor: '#333',
                        barPercentage: 0.5,
                        categoryPercentage: 0.8,
                        order: 1
                    },
                    {
                        label: 'Actual',
                        data: dataCurrent,
                        backgroundColor: keys.map(k => currentCounts[k] >= METAS_SEMANALES[k] ? '#2ecc71' : '#d62828'),
                        barPercentage: 0.5, // Mismo ancho para solapar visualmente
                        categoryPercentage: 0.8,
                        order: 0
                    }
                ];

                document.getElementById('chartFooterText').innerText = "Barras de color: Tu progreso | Barras grises: La meta";

            } else if (chartMode === 'weeks') {
                document.getElementById('chartTitle').innerText = "Últimas 12 Semanas";
                document.getElementById('chartFooterText').innerText = "% de objetivos semanales cumplidos";
                
                let dataPoints = [];
                for (let i = 11; i >= 0; i--) {
                    let d = new Date(today);
                    d.setDate(d.getDate() - (i * 7)); 
                    let monday = getMonday(d);
                    let dateStr = monday.toISOString().split('T')[0];
                    let result = calculateWeeklyScore(dateStr);
                    dataPoints.push(result.score);
                    labels.push(`${monday.getDate()}/${monday.getMonth()+1}`);
                }
                
                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(214, 40, 40, 0.5)');
                gradient.addColorStop(1, 'rgba(214, 40, 40, 0.0)');

                datasets = [{
                    label: '% Cumplimiento',
                    data: dataPoints,
                    borderColor: '#d62828',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    fill: true,
                    tension: 0.3
                }];

            } else { // Months
                document.getElementById('chartTitle').innerText = "Promedio Mensual (Año)";
                document.getElementById('chartFooterText').innerText = "Promedio del % semanal por mes";
                
                let dataPoints = [];
                const currentYear = today.getFullYear();
                const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                
                for (let m = 0; m < 12; m++) {
                    let sumScore = 0;
                    let weeksCount = 0;
                    let iterDate = new Date(currentYear, m, 1);
                    while (iterDate.getMonth() === m) {
                        if (iterDate.getDay() === 1) { 
                            let dateStr = iterDate.toISOString().split('T')[0];
                            sumScore += calculateWeeklyScore(dateStr).score;
                            weeksCount++;
                        }
                        iterDate.setDate(iterDate.getDate() + 1);
                    }
                    let avg = weeksCount > 0 ? (sumScore / weeksCount) : 0;
                    if (m > today.getMonth()) avg = null;
                    dataPoints.push(avg);
                    labels.push(monthNames[m]);
                }

                 let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(214, 40, 40, 0.5)');
                gradient.addColorStop(1, 'rgba(214, 40, 40, 0.0)');

                datasets = [{
                    label: 'Promedio %',
                    data: dataPoints,
                    borderColor: '#d62828',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    fill: true,
                    tension: 0.3,
                    spanGaps: true
                }];
            }

            if(myChart) myChart.destroy();

            // Config específica para gráfico de barras vs linea
            let scalesConfig = {
                y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#333' } },
                x: { ticks: { color: '#888' }, grid: { display: false } }
            };

            // Ajustar escala Y según modo
            if(chartMode === 'current') {
                scalesConfig.y.max = 5; // Max tareas (aprox)
            } else {
                scalesConfig.y.max = 105; // Porcentaje
            }

            myChart = new Chart(ctx, {
                type: chartType,
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: scalesConfig,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- HISTORIAL ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            const sortedDates = Object.keys(appData).sort().reverse();
            if(sortedDates.length === 0) { list.innerHTML = '<li style="text-align:center; color:#555;">No hay registros aún.</li>'; return; }
            
            sortedDates.forEach(date => {
                const data = appData[date];
                const dateObj = new Date(date + "T00:00:00"); 
                const options = { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' };
                const dateString = dateObj.toLocaleDateString('es-ES', options);
                
                let detailsHTML = '';
                if(data.movilidad) detailsHTML += '<i class="fa-solid fa-person-walking" style="color:#f1c40f"></i> ';
                if(data.superior) detailsHTML += '<i class="fa-solid fa-dumbbell" style="color:#3498db"></i> ';
                if(data.inferior) detailsHTML += '<i class="fa-solid fa-shoe-prints" style="color:#9b59b6"></i> ';
                if(data.cuello) detailsHTML += '<i class="fa-solid fa-helmet-safety" style="color:#e67e22"></i> ';
                if(data.fsae) detailsHTML += '<i class="fa-solid fa-car-side" style="color:#d62828"></i> ';
                if(detailsHTML === '') detailsHTML = 'Descanso';
                
                const li = document.createElement('li');
                li.className = `history-item score-0`; 
                li.onclick = () => { document.getElementById('dateInput').value = date; openTab('ingreso'); loadDayData(); };
                li.innerHTML = `<div><div class="hist-date">${dateString}</div><div class="hist-details">${detailsHTML}</div></div>`;
                list.appendChild(li);
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
    </script>
</body>
</html>